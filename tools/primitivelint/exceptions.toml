# SPDX-License-Identifier: MPL-2.0
#
# primitivelint exceptions — intentional primitive type usage
#
# This file documents every known location where bare primitive types are
# intentionally retained. Each entry includes a reason explaining why the
# DDD Value Type pattern was not applied.
#
# Pattern syntax:
#   Type.Field           — exact struct field match
#   Function.param       — function param by name
#   Function.return.N    — return type by position (0-indexed)
#   *.Field              — any type, specific field name
#   Package.Type.*       — all fields on a type
#
# To add a new exception, append an [[exceptions]] entry with both
# pattern and reason fields.

[settings]
# Types that are never flagged regardless of context.
skip_types = ["bool", "error", "context.Context", "any"]

# File paths containing these substrings are excluded entirely.
exclude_paths = [
    "specs/",             # Specification/contract files, not production code
    "internal/testutil/", # Test utilities, not domain types
]

# =============================================================================
# Exec / OS Boundary
# =============================================================================
# Values passed directly to exec.CommandContext, os.Stat, filepath.Join,
# or similar stdlib calls where named types would add more casts than
# they remove.

[[exceptions]]
pattern = "ExecuteRequest.Name"
reason = "Cobra + interface boundary"

[[exceptions]]
pattern = "ExecuteRequest.Args"
reason = "exec boundary (positional args passed to shell)"

[[exceptions]]
pattern = "ExecuteRequest.EnvVars"
reason = "exec/OS boundary (KEY=VALUE env pairs)"

[[exceptions]]
pattern = "ExecuteRequest.UserEnv"
reason = "exec/OS boundary (captured host environment)"

[[exceptions]]
pattern = "ExecutionContext.PositionalArgs"
reason = "exec boundary (shell positional parameters)"

[[exceptions]]
pattern = "EnvContext.ExtraEnv"
reason = "exec/OS boundary"

[[exceptions]]
pattern = "EnvContext.RuntimeEnvVars"
reason = "exec/OS boundary"

[[exceptions]]
pattern = "BuildExecutionContextOptions.Args"
reason = "exec/OS boundary"

[[exceptions]]
pattern = "BuildExecutionContextOptions.EnvVars"
reason = "exec/OS boundary"

[[exceptions]]
pattern = "BaseCLIEngine.cmdEnvOverrides"
reason = "exec/OS boundary"

[[exceptions]]
pattern = "BaseCLIEngine.name"
reason = "display label"

[[exceptions]]
pattern = "containerExecPrep.shellCmd"
reason = "exec boundary"

[[exceptions]]
pattern = "containerExecPrep.env"
reason = "exec boundary"

[[exceptions]]
pattern = "SpinCommandOptions.Command"
reason = "exec command slice"

[[exceptions]]
pattern = "ShebangInfo.Args"
reason = "exec boundary"

[[exceptions]]
pattern = "ShebangInfo.Interpreter"
reason = "full paths like /bin/bash; BinaryName rejects paths"

[[exceptions]]
pattern = "Engine.BinaryPath.return.0"
reason = "7+ call sites pass to exec.CommandContext; would add casts"

[[exceptions]]
pattern = "ResolveDockerfilePath.*"
reason = "exec boundary — params/return passed to filepath operations"

# =============================================================================
# Display-Only Fields
# =============================================================================
# Fields whose values are only rendered for human consumption, with no
# programmatic interpretation.

[[exceptions]]
pattern = "ValidationIssue.Message"
reason = "display-only"

[[exceptions]]
pattern = "ValidationIssue.Path"
reason = "display-only"

[[exceptions]]
pattern = "ValidationError.Field"
reason = "display-only field path label"

[[exceptions]]
pattern = "InitDiagnostic.Message"
reason = "display-only diagnostic message"

[[exceptions]]
pattern = "Diagnostic.Message"
reason = "display-only diagnostic message"

[[exceptions]]
pattern = "CapabilityError.Message"
reason = "display-only error detail"

[[exceptions]]
pattern = "EngineNotAvailableError.Reason"
reason = "display-only error detail"

[[exceptions]]
pattern = "Result.Output"
reason = "raw captured stdout"

[[exceptions]]
pattern = "Result.ErrOutput"
reason = "raw captured stderr"

[[exceptions]]
pattern = "SpinResult.Stdout"
reason = "raw captured output"

[[exceptions]]
pattern = "SpinResult.Stderr"
reason = "raw captured output"

[[exceptions]]
pattern = "ModuleCollisionError.FirstSource"
reason = "composite display string"

[[exceptions]]
pattern = "ModuleCollisionError.SecondSource"
reason = "composite display string"

[[exceptions]]
pattern = "StyledMessage"
reason = "rendering output"

# =============================================================================
# Import Cycle Prevention
# =============================================================================
# Using typed fields would require importing a package that creates a
# circular dependency.

[[exceptions]]
pattern = "tuiserver.*.*"
reason = "import cycle: tui->tuiserver; JSON wire format for all protocol types"

[[exceptions]]
pattern = "URLWithHost.host"
reason = "only 2 possible values, import cycle concern"

# =============================================================================
# Free-Form User Input
# =============================================================================
# Values from user input or external sources with no fixed domain type.

[[exceptions]]
pattern = "*.DefaultValue"
reason = "free-form flag/argument default"

[[exceptions]]
pattern = "ArgumentValidationError.InvalidValue"
reason = "free-form user input / Cobra boundary"

[[exceptions]]
pattern = "ArgumentValidationError.ProvidedArgs"
reason = "free-form user input / Cobra boundary"

[[exceptions]]
pattern = "AmbiguousIdentifierError.Identifier"
reason = "free-form user input"

[[exceptions]]
pattern = "cmdFlagValues.runtimeOverride"
reason = "Cobra flag binding"

[[exceptions]]
pattern = "cmdFlagValues.fromSource"
reason = "Cobra flag binding"

# =============================================================================
# Wire / Interface / External Boundaries
# =============================================================================
# Values crossing serialization, framework, or external contract boundaries.

[[exceptions]]
pattern = "EnvConfig.Vars"
reason = "map key breaks maps.Copy compatibility"

[[exceptions]]
pattern = "Token.CommandID"
reason = "composite string"

[[exceptions]]
pattern = "ConnectionInfo.User"
reason = "always 'invowk'"

[[exceptions]]
pattern = "Server.addr"
reason = "composite 'host:port'"

[[exceptions]]
pattern = "TagInfo.Name"
reason = "go-git pass-through"

[[exceptions]]
pattern = "UnpackOptions.Source"
reason = "mixed path/URL"

[[exceptions]]
pattern = "ListCommands.return.*"
reason = "interface contract"

[[exceptions]]
pattern = "FieldPath.EnvVar.key"
reason = "EnvConfig.Vars map key is intentionally string"

[[exceptions]]
pattern = "FieldPath.Field.name"
reason = "generic field name adder"

# =============================================================================
# Internal Parse-Tree / Domain-Specific Fields
# =============================================================================

[[exceptions]]
pattern = "Version.Prerelease"
reason = "internal parse-tree field"

[[exceptions]]
pattern = "Version.Original"
reason = "internal parse-tree field"

[[exceptions]]
pattern = "Constraint.Original"
reason = "internal parse-tree field"

[[exceptions]]
pattern = "SemverResolver.Resolve.constraintStr"
reason = "constraint expression, not a version tag"

[[exceptions]]
pattern = "configDirFrom.goos"
reason = "runtime.GOOS boundary, no typed alternative"

[[exceptions]]
pattern = "moduleError.op"
reason = "unexported display label"

[[exceptions]]
pattern = "checkCommandDependenciesExist.currentModule"
reason = "empty string = no module; ModuleID rejects empty"

# =============================================================================
# Test-Only Fields
# =============================================================================

[[exceptions]]
pattern = "provision.Config.TagSuffix"
reason = "test-only"

# =============================================================================
# TUI Display Labels
# =============================================================================
# All TUI option Title/Description/Placeholder etc. fields are display
# labels with no domain semantics beyond rendering.

[[exceptions]]
pattern = "*.Title"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Description"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Placeholder"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Value"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Prompt"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Affirmative"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Negative"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Cursor"
reason = "TUI display label"

[[exceptions]]
pattern = "*.Separator"
reason = "TUI display label"

[[exceptions]]
pattern = "TableOptions.Rows"
reason = "display data ([][]string)"

[[exceptions]]
pattern = "FilterOptions.Options"
reason = "display data ([]string)"

[[exceptions]]
pattern = "ChooseStringOptions.Options"
reason = "display data ([]string)"

[[exceptions]]
pattern = "FormatOptions.Content"
reason = "rendering input"

[[exceptions]]
pattern = "FormatOptions.Language"
reason = "external open-ended enum"

[[exceptions]]
pattern = "FormatOptions.GlamourTheme"
reason = "external open-ended enum"

# =============================================================================
# Rendering / Output
# =============================================================================

[[exceptions]]
pattern = "VendorResult.Pruned"
reason = "directory base names with .invowkmod suffix"

# =============================================================================
# Unexported Trivial Fields (bulk exceptions)
# =============================================================================
# Unexported fields in structs with many call sites where casts would
# dominate with no external benefit.

[[exceptions]]
pattern = "uroot.FlagInfo.Name"
reason = "constant string literals across 25 files, near-zero risk"

[[exceptions]]
pattern = "uroot.FlagInfo.ShortName"
reason = "constant string literals across 25 files"

[[exceptions]]
pattern = "uroot.FlagInfo.Description"
reason = "constant string literals across 25 files"

[[exceptions]]
pattern = "uroot.*.name"
reason = "display-only labels in 12+ unexported structs"

[[exceptions]]
pattern = "watch.Watcher.baseDir"
reason = "unexported, 8+ filepath.* casts for no external benefit"

# =============================================================================
# Interface Contract Implementations
# =============================================================================
# Method signatures dictated by external interfaces that cannot use named types.

[[exceptions]]
pattern = "uroot.*.Run.args"
reason = "uroot Command interface contract: Run(ctx, args []string)"

[[exceptions]]
pattern = "uroot.*.Name.return.0"
reason = "uroot Command interface contract: Name() string"

[[exceptions]]
pattern = "*.View.return.0"
reason = "bubbletea tea.Model interface: View() string"

[[exceptions]]
pattern = "*.FilterValue.return.0"
reason = "bubbles list.Item interface: FilterValue() string"

[[exceptions]]
pattern = "*.Height.return.0"
reason = "bubbles list.ItemDelegate interface: Height() int"

[[exceptions]]
pattern = "*.Spacing.return.0"
reason = "bubbles list.ItemDelegate interface: Spacing() int"

# =============================================================================
# Error Detail Fields
# =============================================================================
# Display-only reason/message fields in InvalidXxxError structs, same semantic
# category as already-excepted CapabilityError.Message.

[[exceptions]]
pattern = "*.Reason"
reason = "display-only error detail in InvalidXxxError structs"

# =============================================================================
# Set-Tracking Idiom (map[*]bool)
# =============================================================================
# Bool is exempt as a standalone type, but map keys in set-tracking patterns
# are idiomatic Go and carry no domain semantics.

[[exceptions]]
pattern = "*.selected"
reason = "map[int]bool selection set (bool value carries no domain meaning)"

[[exceptions]]
pattern = "*.seenNames"
reason = "map[string]bool deduplication set (internal validation)"

[[exceptions]]
pattern = "*.seenShorts"
reason = "map[string]bool deduplication set"

[[exceptions]]
pattern = "*.expectedDirs"
reason = "map[string]bool directory-name set"

# =============================================================================
# Container / Runtime Exec Boundary (additional)
# =============================================================================
# Container-specific exec boundary fields not covered by existing patterns.

[[exceptions]]
pattern = "RunOptions.Command"
reason = "exec boundary (container command slice)"

[[exceptions]]
pattern = "RunOptions.Env"
reason = "exec/OS boundary (container env map)"

[[exceptions]]
pattern = "BuildOptions.BuildArgs"
reason = "exec boundary (docker --build-arg map)"

[[exceptions]]
pattern = "envInheritConfig.*"
reason = "exec/OS boundary (env var name lists for filtering)"

# =============================================================================
# MEMORY.md Gap Fixes
# =============================================================================

[[exceptions]]
pattern = "*.FlagValues"
reason = "map value is free-form user input; key is already typed FlagName"

[[exceptions]]
pattern = "*.commandID"
reason = "composite string (sshserver Token.CommandID)"

[[exceptions]]
pattern = "*.message"
reason = "display-only diagnostic/error message (constructor params)"

# =============================================================================
# TUI Rendering Internals
# =============================================================================
# Low-level ANSI terminal rendering functions that operate on raw terminal
# output — no domain semantics, just string/int manipulation for rendering.

[[exceptions]]
pattern = "tui.hexToANSIBackground.*"
reason = "ANSI rendering internal — operates on raw terminal output"

[[exceptions]]
pattern = "tui.sanitizeModalBackground.*"
reason = "ANSI rendering internal"

[[exceptions]]
pattern = "tui.compositeLineANSI.*"
reason = "ANSI rendering internal"

[[exceptions]]
pattern = "tui.getANSISuffix.*"
reason = "ANSI rendering internal"

[[exceptions]]
pattern = "tui.padLineToWidth.*"
reason = "ANSI rendering internal"

[[exceptions]]
pattern = "tui.RenderOverlay.*"
reason = "rendering output composition"

# =============================================================================
# Remaining Intentional int Exceptions
# =============================================================================

[[exceptions]]
pattern = "TableOptions.SelectedIndex"
reason = "array index"

[[exceptions]]
pattern = "TableSelectionResult.SelectedIndex"
reason = "array index"

[[exceptions]]
pattern = "ArgumentValidationError.MinArgs"
reason = "argument count value"

[[exceptions]]
pattern = "ArgumentValidationError.MaxArgs"
reason = "argument count value"

[[exceptions]]
pattern = "WriteOptions.CharLimit"
reason = "count for huh boundary"

[[exceptions]]
pattern = "InputOptions.CharLimit"
reason = "count for huh boundary"

[[exceptions]]
pattern = "ChooseStringOptions.Limit"
reason = "count value"

[[exceptions]]
pattern = "MultiChooseOptions.Limit"
reason = "count value"

[[exceptions]]
pattern = "FilterOptions.Limit"
reason = "count value"

# =============================================================================
# Remaining Intentional []int Exceptions
# =============================================================================

[[exceptions]]
pattern = "Style.Padding"
reason = "lipgloss CSS-shorthand passthrough; import cycle with tuiserver"

[[exceptions]]
pattern = "Style.Margin"
reason = "lipgloss CSS-shorthand passthrough; import cycle with tuiserver"

# =============================================================================
# Mutable-by-Design Structs (DDD Entities / Post-Construction Mutation)
# =============================================================================
# These structs have constructors but are NOT Value Types — they are Entities
# or DTOs with intentional post-construction mutation. Immutability enforcement
# is not appropriate.

[[exceptions]]
pattern = "discovery.DiscoveredCommandSet.immutability"
reason = "maps populated post-construction in processDiscoveredFiles()"

[[exceptions]]
pattern = "runtime.ExecutionContext.immutability"
reason = "13 fields set post-construction in BuildExecutionContext(); DDD Entity"

[[exceptions]]
pattern = "runtime.DefaultEnvBuilder.immutability"
reason = "Environ is intentionally public for composition"

[[exceptions]]
pattern = "invowk.App.immutability"
reason = "fields set in NewApp() but accessed broadly; DDD Entity"

[[exceptions]]
pattern = "invowkmod.CommandScope.immutability"
reason = "has AddDirectDep() mutation method; DDD Entity"

[[exceptions]]
pattern = "invowkmod.LockFile.immutability"
reason = "Modules map mutated in resolver.go (Add/Remove/Update); DDD Entity"

[[exceptions]]
pattern = "invowkfile.ValidationError.immutability"
reason = "70+ struct literal sites across validation_structure_*.go; separate PR"

# --- Service Objects: struct-isvalid exceptions ---
# Service objects, registries, builders, and state machines have runtime-dynamic
# validity (engine availability, post-construction population, lifecycle state).
# IsValid() is not meaningful for these — construction guarantees internal consistency.

# Service objects — container engines
[[exceptions]]
pattern = "container.BaseCLIEngine.struct-isvalid"
reason = "service object; binaryPath='' valid for 'not found' sentinel"

[[exceptions]]
pattern = "container.DockerEngine.struct-isvalid"
reason = "service object; wraps BaseCLIEngine"

[[exceptions]]
pattern = "container.PodmanEngine.struct-isvalid"
reason = "service object; wraps BaseCLIEngine"

[[exceptions]]
pattern = "container.SandboxAwareEngine.struct-isvalid"
reason = "service decorator; used via Engine interface"

# Service objects — servers, provisioners, runtimes
[[exceptions]]
pattern = "serverbase.Base.struct-isvalid"
reason = "lifecycle state machine; validity is runtime state"

[[exceptions]]
pattern = "provision.LayerProvisioner.struct-isvalid"
reason = "service object; fields always non-nil from constructor"

[[exceptions]]
pattern = "runtime.ContainerRuntime.struct-isvalid"
reason = "stateful service with mutex/atomic; single-instance"

[[exceptions]]
pattern = "runtime.NativeRuntime.struct-isvalid"
reason = "service object; shell='' valid for auto-detect"

[[exceptions]]
pattern = "runtime.VirtualRuntime.struct-isvalid"
reason = "service object; invariants enforced by constructor"

# Service objects — module resolution
[[exceptions]]
pattern = "invowkmod.Resolver.struct-isvalid"
reason = "stateful service with mutex; constructor returns error"

[[exceptions]]
pattern = "invowkmod.GitFetcher.struct-isvalid"
reason = "service object; empty cacheDir valid for default"

# Zero-field stateless services
[[exceptions]]
pattern = "invowkfile.StructureValidator.struct-isvalid"
reason = "zero-field struct; no invariants"

[[exceptions]]
pattern = "invowkmod.SemverResolver.struct-isvalid"
reason = "zero-field struct; no invariants"

# Mutable entities (already have .immutability exceptions)
[[exceptions]]
pattern = "invowk.App.struct-isvalid"
reason = "composition root; validity is runtime-dynamic"

[[exceptions]]
pattern = "discovery.DiscoveredCommandSet.struct-isvalid"
reason = "maps populated post-construction"

[[exceptions]]
pattern = "runtime.ExecutionContext.struct-isvalid"
reason = "13 fields set post-construction; DDD Entity"

[[exceptions]]
pattern = "runtime.DefaultEnvBuilder.struct-isvalid"
reason = "strategy; nil Environ valid (os.Environ fallback)"

[[exceptions]]
pattern = "invowkmod.CommandScope.struct-isvalid"
reason = "has AddDirectDep() mutation; DDD Entity"

[[exceptions]]
pattern = "invowkmod.LockFile.struct-isvalid"
reason = "Modules map mutated by resolver; DDD Entity"

# Registries (post-construction population)
[[exceptions]]
pattern = "runtime.Registry.struct-isvalid"
reason = "runtime registration container; populated via Register()"

[[exceptions]]
pattern = "uroot.Registry.struct-isvalid"
reason = "command registration container; populated via Register()"

# Fluent builders (mutable by design)
[[exceptions]]
pattern = "issue.ErrorContext.struct-isvalid"
reason = "fluent builder; accumulates state before BuildError()"

[[exceptions]]
pattern = "invowkfile.FieldPath.struct-isvalid"
reason = "fluent builder; mutated by Root()/Command()/Flag()"

# Composite pattern
[[exceptions]]
pattern = "invowkfile.CompositeValidator.struct-isvalid"
reason = "composite pattern; has Add() mutation method"
