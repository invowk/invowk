# Main Execution Sequence Diagram
#
# Shows the high-level flow of command execution from user request
# through initialization, discovery, resolution, and execution phases.
#
# Source: cmd/invowk/cmd_execute.go (commandService pipeline)

vars: {
  d2-config: {
    layout-engine: tala
  }
}

shape: sequence_diagram

# Participants
User
CLI: CLI (CommandService)
Config: Configuration
Disc: Discovery Engine
CUE: CUE Parser
Registry: Runtime Registry
Runtime: Selected Runtime

# Entry point
User -> CLI: "invowk cmd <name> [args...]"

# 1. Initialization Phase
CLI -> Config: Load configuration
Config -> CUE: Parse config.cue
CUE -> Config: Config struct
Config -> CLI: Configuration loaded

# 2. Discovery Phase
CLI -> Disc: DiscoverCommands(searchPaths)
Disc -> CUE: Parse invowkfile.cue files
CUE -> Disc: Invowkfile structs
Disc -> CUE: Parse *.invowkmod directories
CUE -> Disc: Module structs
Disc -> CLI: "CommandInfo[] (unified tree)"

# 3. Resolution Phase
CLI -> CLI: Match command by name
CLI -> CLI: Select implementation (platform match)
CLI -> Registry: GetRuntime(implementation.runtime)
Registry -> CLI: Runtime instance
CLI -> Runtime: Validate(context)
Runtime -> CLI: Validation result

# 4. Execution Phase
CLI -> Runtime: Execute(context)
Runtime -> Runtime: Run script/command
Runtime -> CLI: Result

# Return result
CLI -> User: Output + Exit code
