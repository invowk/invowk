# Ephemeral Layer Contents Flowchart
#
# Shows what Invowk adds to the base container image
# when provisioning for container runtime execution.
#
# Source: docs/architecture/flowchart-runtime-selection.md

vars: {
  d2-config: {
    layout-engine: tala
  }
}

direction: down

# ==============================================================================
# Entry Point
# ==============================================================================

Start: Start layer provisioning {
  shape: oval
  style.fill: "#E8F5E9"
}

# ==============================================================================
# Ephemeral Layer Contents
# ==============================================================================

layer_contents: Ephemeral Layer Contents {
  style: {
    stroke: "#1168BD"
    stroke-dash: 3
    fill: transparent
  }

  Binary: /invowk/bin/invowk\n(Invowk binary) {
    style.fill: "#BBDEFB"
  }

  Modules: /invowk/modules/\n(Provisioned modules) {
    style.fill: "#BBDEFB"
  }

  EnvVars: ENV PATH="/invowk/bin:..."\nENV INVOWK_MODULE_PATH="/invowk/modules" {
    style.fill: "#BBDEFB"
  }
}

# ==============================================================================
# Build Flow
# ==============================================================================

Base: Base Image {
  style.fill: "#E8E8E8"
}

Layer: Ephemeral Layer {
  style.fill: "#C8E6C9"
}

RuntimeMount: Runtime bind mount\n(host invowkfile dir -> /workspace)\n(not part of layer) {
  style.fill: "#FFF3E0"
}

Base -> Layer
Layer -> layer_contents.Binary
Layer -> layer_contents.Modules
Layer -> layer_contents.EnvVars
Layer -> RuntimeMount
Start -> Base
