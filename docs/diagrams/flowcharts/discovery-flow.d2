# Command Discovery Flow Flowchart
#
# Shows how Invowk discovers commands from multiple sources
# with priority ordering: current directory > local modules >
# configured includes > user directory.
#
# Source: docs/architecture/flowchart-discovery.md

vars: {
  d2-config: {
    layout-engine: tala
  }
}

direction: down

# ==============================================================================
# Entry Point
# ==============================================================================

Start: Discovery Start {
  shape: oval
  style.fill: "#E8F5E9"
}

# ==============================================================================
# Priority 1: Current Directory
# ==============================================================================

priority1: Priority 1: Current Directory {
  style: {
    stroke: "#1168BD"
    stroke-dash: 3
    fill: transparent
  }

  PWD: Check ./invowkfile.cue

  HasPWD: Found? {
    shape: diamond
    style.fill: "#FFF3E0"
  }

  ParsePWD: Parse invowkfile.cue\nPriority: HIGHEST {
    style.fill: "#C8E6C9"
  }

  Skip1: Continue

  PWD -> HasPWD
  HasPWD -> ParsePWD: Yes
  HasPWD -> Skip1: No
}

Start -> priority1.PWD

# ==============================================================================
# Priority 2: Local Modules
# ==============================================================================

priority2: Priority 2: Local Modules {
  style: {
    stroke: "#1168BD"
    stroke-dash: 3
    fill: transparent
  }

  Modules: Scan for ./*.invowkmod

  HasMods: Found modules? {
    shape: diamond
    style.fill: "#FFF3E0"
  }

  ParseMods: Load + parse each module {
    style.fill: "#BBDEFB"
  }

  VendoredLocal: Scan invowk_modules/\n(one level only) {
    style.fill: "#BBDEFB"
  }

  Skip2: Continue

  Modules -> HasMods
  HasMods -> ParseMods: Yes
  HasMods -> Skip2: No
  ParseMods -> VendoredLocal
}

priority1.ParsePWD -> priority2.Modules
priority1.Skip1 -> priority2.Modules

# ==============================================================================
# Priority 3: Configured Includes
# ==============================================================================

priority3: Priority 3: Configured Includes {
  style: {
    stroke: "#1168BD"
    stroke-dash: 3
    fill: transparent
  }

  SearchPaths: Check configured\nincludes\n(module paths from config)

  HasPaths: Found? {
    shape: diamond
    style.fill: "#FFF3E0"
  }

  ParsePaths: Load + parse\nincluded modules {
    style.fill: "#BBDEFB"
  }

  VendoredIncludes: Scan vendored modules\nfor included modules {
    style.fill: "#BBDEFB"
  }

  Skip3: Continue

  SearchPaths -> HasPaths
  HasPaths -> ParsePaths: Yes
  HasPaths -> Skip3: No
  ParsePaths -> VendoredIncludes
}

priority2.VendoredLocal -> priority3.SearchPaths
priority2.Skip2 -> priority3.SearchPaths

# ==============================================================================
# Priority 4: User Directory
# ==============================================================================

priority4: Priority 4: User Directory {
  style: {
    stroke: "#1168BD"
    stroke-dash: 3
    fill: transparent
  }

  UserDir: Check ~/.invowk/cmds/\n(modules only, non-recursive)

  HasUser: Found? {
    shape: diamond
    style.fill: "#FFF3E0"
  }

  ParseUser: Load + parse user modules {
    style.fill: "#FFE4B5"
  }

  VendoredUser: Scan vendored modules\nfor user-dir modules {
    style.fill: "#FFE4B5"
  }

  UserDir -> HasUser
  HasUser -> ParseUser: Yes
  ParseUser -> VendoredUser
}

priority3.VendoredIncludes -> priority4.UserDir
priority3.Skip3 -> priority4.UserDir

# ==============================================================================
# End Point
# ==============================================================================

VendoredRule: invowk_modules/ scanned\none level only.\nNested vendored modules\nignored with diagnostics. {
  shape: page
  style.fill: "#FFF3E0"
  style.font-size: 13
}

Done: Build unified\ncommand tree {
  shape: oval
  style.fill: "#E8F5E9"
}

priority4.VendoredUser -> VendoredRule
VendoredRule -> Done
priority4.HasUser -> Done: No
