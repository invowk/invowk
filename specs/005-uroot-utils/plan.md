# Implementation Plan: u-root Utils Integration

**Branch**: `005-uroot-utils` | **Date**: 2026-01-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-uroot-utils/spec.md`

## Summary

Enable built-in file utilities in Invowk's virtual shell runtime by integrating u-root library packages (`github.com/u-root/u-root/pkg/core`) and implementing custom utilities for missing commands. This makes the virtual runtime self-contained, allowing scripts to execute file operations without requiring external binaries on the host system.

## Technical Context

**Language/Version**: Go 1.26+
**Primary Dependencies**:
- `mvdan.cc/sh/v3` v3.12.0 (existing - virtual shell interpreter)
- `github.com/u-root/u-root` v0.15.0 (new - utility implementations)

**Storage**: N/A (no persistent storage required)
**Testing**: Go stdlib `testing` + `testscript` for CLI integration
**Target Platform**: Linux, macOS, Windows (all platforms supported by virtual runtime)
**Project Type**: Single project (Go CLI tool)
**Performance Goals**: No measurable impact on shell script execution latency; constant memory usage for file operations (streaming I/O)
**Constraints**: Memory usage must be O(1) for file operations regardless of file size
**Scale/Scope**: 15 u-root utility implementations (7 pkg/core wrappers: `cat`, `cp`, `ls`, `mkdir`, `mv`, `rm`, `touch` + 8 custom: `cut`, `grep`, `head`, `sort`, `tail`, `tr`, `uniq`, `wc`)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Idiomatic Go & Schema-Driven Design | ✅ PASS | Using existing CUE schema; following error handling patterns |
| II. Comprehensive Testing Discipline | ✅ PASS | Unit tests + CLI integration tests planned |
| III. Consistent User Experience | ✅ PASS | Error format specified (`[uroot]` prefix); flag handling defined |
| IV. Single-Binary Performance | ✅ PASS | Streaming I/O ensures constant memory; u-root packages are lightweight |
| V. Simplicity & Minimalism | ✅ PASS | Using existing library (u-root) rather than reimplementing |
| VI. Documentation Synchronization | ⚠️ PENDING | Docs must be updated when feature is implemented |
| VII. Pre-Existing Issue Resolution | ✅ PASS | No blockers identified; handler infrastructure already exists |

**Post-Design Re-Check**: All principles still satisfied. Custom implementations follow same interface as pkg/core wrappers.

## Project Structure

### Documentation (this feature)

```text
specs/005-uroot-utils/
├── plan.md              # This file
├── research.md          # Phase 0 output (completed)
├── data-model.md        # Phase 1 output (completed)
├── quickstart.md        # Phase 1 output (completed)
├── contracts/           # Phase 1 output (completed)
│   └── uroot_interface.go  # Go interface definitions
└── tasks.md             # Phase 2 output (to be generated by /speckit.tasks)
```

### Source Code (repository root)

```text
internal/
├── uroot/                    # NEW: u-root utilities integration
│   ├── doc.go                # Package documentation
│   ├── registry.go           # Command registry
│   ├── handler.go            # HandlerContext extraction
│   ├── wrapper.go            # Base wrapper for pkg/core commands
│   │
│   │ # pkg/core wrappers
│   ├── cat.go                # Wrapper for pkg/core/cat
│   ├── cp.go                 # Wrapper for pkg/core/cp
│   ├── ls.go                 # Wrapper for pkg/core/ls
│   ├── mkdir.go              # Wrapper for pkg/core/mkdir
│   ├── mv.go                 # Wrapper for pkg/core/mv
│   ├── rm.go                 # Wrapper for pkg/core/rm
│   ├── touch.go              # Wrapper for pkg/core/touch
│   │
│   │ # Custom implementations
│   ├── head.go               # Custom: first N lines
│   ├── tail.go               # Custom: last N lines
│   ├── wc.go                 # Custom: word/line/byte count
│   ├── grep.go               # Custom: pattern matching
│   ├── sort.go               # Custom: sort lines
│   ├── uniq.go               # Custom: unique lines
│   ├── cut.go                # Custom: select fields
│   ├── tr.go                 # Custom: translate characters
│   │
│   │ # Tests
│   ├── registry_test.go
│   ├── cat_test.go
│   ├── cp_test.go
│   ├── ls_test.go
│   ├── mkdir_test.go
│   ├── mv_test.go
│   ├── rm_test.go
│   ├── touch_test.go
│   ├── head_test.go
│   ├── tail_test.go
│   ├── wc_test.go
│   ├── grep_test.go
│   ├── sort_test.go
│   ├── uniq_test.go
│   ├── cut_test.go
│   └── tr_test.go
│
└── runtime/
    └── virtual.go            # MODIFY: Wire up u-root registry in tryUrootBuiltin

tests/cli/testdata/
├── uroot_basic.txtar         # NEW: Basic u-root utility tests
├── uroot_file_ops.txtar      # NEW: File operation tests (cp, mv, rm)
└── uroot_text_ops.txtar      # NEW: Text operation tests (head, tail, grep)
```

**Structure Decision**: Single `internal/uroot` package isolates u-root integration complexity from the virtual runtime. Each utility has its own file for maintainability. Tests are co-located following Go conventions.

## Implementation Phases

### Phase 1: Core Infrastructure

1. **Add u-root dependency**: `go get github.com/u-root/u-root@v0.15.0`
2. **Create `internal/uroot/` package structure**
3. **Implement `UrootCommand` interface and `Registry`**
4. **Implement `HandlerContext` extraction from mvdan/sh context**
5. **Wire registry into `VirtualRuntime.tryUrootBuiltin()`**

### Phase 2: pkg/core Wrappers (7 utilities)

Implement wrappers in order of dependency (later utilities may depend on earlier ones for testing):

1. `cat` - Foundation for testing other utilities
2. `mkdir` - Required for `cp` tests
3. `rm` - Required for test cleanup
4. `touch` - Simple, good for validating wrapper pattern
5. `cp` - Core file operation
6. `mv` - Depends on `cp` concepts
7. `ls` - Directory listing

### Phase 3: Custom Implementations (8 utilities)

Implement in order of complexity:

1. `head` - Simplest: line counter with early exit
2. `tail` - Ring buffer for N lines
3. `wc` - Streaming counters
4. `uniq` - Adjacent line comparison
5. `cut` - Field delimiter parsing
6. `tr` - Character mapping
7. `grep` - Regex matching per line
8. `sort` - Most complex: may need temp files

### Phase 4: Testing & Documentation

1. Unit tests for each utility (table-driven)
2. CLI integration tests (testscript)
3. Cross-platform verification
4. Documentation updates:
   - `website/docs/runtime-modes/virtual.mdx`
   - `README.md` (mention u-root support)
   - Config documentation for `enable_uroot_utils`

## Key Design Decisions

### Decision 1: Use pkg/core where available

**Choice**: Wrap `github.com/u-root/u-root/pkg/core/*` packages for `cat`, `cp`, `ls`, `mkdir`, `mv`, `rm`, `touch`

**Rationale**: Reusing battle-tested implementations reduces bugs and maintenance burden

**Alternative Rejected**: Implementing all utilities from scratch - would require significant effort with no benefit

### Decision 2: Custom implementations for missing utilities

**Choice**: Implement `head`, `tail`, `wc`, `grep`, `sort`, `uniq`, `cut`, `tr` following the same interface

**Rationale**: These are commonly used in shell scripts; without them, the feature value is diminished

**Alternative Rejected**: Limiting scope to pkg/core utilities only - would leave gaps in common use cases

### Decision 3: Error prefix format

**Choice**: All errors prefixed with `[uroot] <cmd>: <message>`

**Rationale**: Clear identification of error source aids debugging; required by spec FR-006

### Decision 4: Silently ignore unsupported flags

**Choice**: Parse known flags, silently ignore unknown ones (no warnings)

**Rationale**: Provides better compatibility with scripts written for GNU coreutils; required by spec

### Decision 5: No automatic fallback to system utilities

**Choice**: If u-root implementation fails, return error (don't try system binary)

**Rationale**: Silent fallback could mask implementation bugs; required by spec FR-007

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| u-root API changes | Pin to v0.15.0; add version guard in go.mod |
| pkg/core missing features | Document supported flags; custom implementations for critical features |
| Memory issues with large files | Streaming I/O required; benchmark tests verify |
| Cross-platform inconsistencies | Test suite runs on Linux, macOS, Windows CI |
| Binary size increase | Monitor with `make build`; u-root packages are modular |

## Complexity Tracking

> No Constitution Check violations requiring justification.

| Item | Complexity | Justification |
|------|------------|---------------|
| 8 custom implementations | Medium | Required for feature completeness; spec mandates these utilities |
| New internal package | Low | Standard Go organization; isolates u-root concerns |

## Dependencies

### New Go Dependencies

```
github.com/u-root/u-root v0.15.0
```

### Transitive Dependencies

The u-root library brings minimal transitive dependencies. Key ones:
- `golang.org/x/sys` (already in project via other deps)
- `golang.org/x/term` (already in project via other deps)

### Compatibility Notes

- The u-root library requires Go 1.24+; Invowk requires Go 1.26+ (compatible)
- The u-root library is BSD-3-Clause licensed (compatible with MPL-2.0)
- No breaking changes expected from u-root's stable pkg/core API

## Checklist for Implementation

Before PR:
- [ ] `make lint` passes
- [ ] `make test` passes
- [ ] `make test-cli` passes (new testscript tests)
- [ ] `make license-check` passes (new .go files have SPDX headers)
- [ ] `make tidy` run after adding u-root dependency
- [ ] Documentation updated per Principle VI
- [ ] Streaming I/O verified (no io.ReadAll for file content)
- [ ] Error prefix format verified (`[uroot]`)
