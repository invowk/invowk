# Test: Ambiguous command listing using native runtime (User Story 3)
# Mirrors virtual_ambiguity.txtar but with platform-split native implementations
# Tests that commands with the same name from different sources show disambiguation annotations
# and cannot be executed without explicit source specification

# Change to work directory where the test files will be created
cd $WORK

# Test 1: List commands - ambiguous commands should show source annotation
# The "deploy" command exists in both invowkfile and foo.invowkmod
exec invowk cmd
stdout 'From invowkfile:'
stdout 'hello'
stdout 'deploy.*@invowkfile'
stdout 'From foo.invowkmod:'
stdout 'build'
stdout 'deploy.*@foo'
! stderr .

# Test 2: Unambiguous commands should NOT show source annotation
# "hello" only exists in invowkfile, "build" only exists in foo
exec invowk cmd
! stdout 'hello.*@'
! stdout 'build.*@'

-- invowkfile.cue --
cmds: [
	{
		name:        "hello"
		description: "Hello from root invowkfile"
		implementations: [
			{
				script:    "echo 'Hello from root!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Hello from root!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
	{
		name:        "deploy"
		description: "Deploy from root invowkfile"
		implementations: [
			{
				script:    "echo 'Deploying from invowkfile!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Deploying from invowkfile!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]

-- foo.invowkmod/invowkmod.cue --
module: "foo"
version: "1.0.0"
description: "Foo module"

-- foo.invowkmod/invowkfile.cue --
cmds: [
	{
		name:        "build"
		description: "Build from foo module"
		implementations: [
			{
				script:    "echo 'Building from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Building from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
	{
		name:        "deploy"
		description: "Deploy from foo module"
		implementations: [
			{
				script:    "echo 'Deploying from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Deploying from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]
