# Test: Exit code propagation
# Tests that non-zero exit codes from container commands propagate through CLI

# Skip if no functional container runtime is available
[!container-available] skip 'no functional container runtime available'
# Skip if running inside Flatpak/Snap sandbox (filesystem permissions may prevent volume mounts)
[in-sandbox] skip 'container tests may require --filesystem permissions in sandbox - run tests on host or grant permissions'

# Change to work directory where local invkfile.cue is located
cd $WORK

# Test 1: Exit code 0 (success)
exec invowk cmd exit-zero
stdout 'Exiting with code 0'

# Test 2: Exit code 1 (general error)
! exec invowk cmd exit-one
stdout 'Exiting with code 1'

# Test 3: Exit code 42 (custom exit code)
! exec invowk cmd exit-42
stdout 'Exiting with code 42'

# Test 4: Exit code from failed command
! exec invowk cmd fail-command
stdout 'About to run a failing command'

-- invkfile.cue --
cmds: [
	{
		name: "exit-zero"
		description: "Exit with code 0"
		implementations: [
			{
				script: """
					echo "Exiting with code 0"
					exit 0
					"""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
	},
	{
		name: "exit-one"
		description: "Exit with code 1"
		implementations: [
			{
				script: """
					echo "Exiting with code 1"
					exit 1
					"""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
	},
	{
		name: "exit-42"
		description: "Exit with code 42"
		implementations: [
			{
				script: """
					echo "Exiting with code 42"
					exit 42
					"""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
	},
	{
		name: "fail-command"
		description: "Run a command that fails"
		implementations: [
			{
				script: """
					set -e
					echo "About to run a failing command"
					false
					echo "This should not be printed"
					"""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
	}
]
