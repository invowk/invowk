# Test: Command flag handling (08-flags.tape equivalent)
# Tests flags: simple, defaults, typed, short, validation

cd $WORK

# Test 1: flags simple - basic flags without defaults
exec invowk cmd 'flags simple'
stdout '=== Simple Flags Demo ==='
stdout 'Flags passed to this command are available as environment variables:'
stdout 'INVOWK_FLAG_VERBOSE'
stdout 'INVOWK_FLAG_OUTPUT'
! stderr .

# Test 2: flags defaults - flags with default values
exec invowk cmd 'flags defaults'
stdout '=== Flags with Defaults Demo ==='
stdout 'These flags have default values if not specified:'
stdout 'INVOWK_FLAG_ENV'
stdout 'INVOWK_FLAG_RETRY_COUNT'
stdout 'INVOWK_FLAG_DRY_RUN'
! stderr .

# Test 3: flags typed - typed flags (bool, int, float, string)
exec invowk cmd 'flags typed'
stdout '=== Typed Flags Demo ==='
stdout 'These flags have explicit types:'
stdout 'INVOWK_FLAG_VERBOSE \(bool\)'
stdout 'INVOWK_FLAG_COUNT \(int\)'
stdout 'INVOWK_FLAG_THRESHOLD \(float\)'
stdout 'INVOWK_FLAG_MESSAGE \(string\)'
! stderr .

# Test 4: flags short - flags with short aliases
# Note: Using -- to separate invowk flags from command flags
exec invowk cmd 'flags short' -- -V
stdout '=== Short Flag Aliases Demo ==='
! stderr .

# Test 5: flags validation - regex-validated flags
# Note: Using -- to separate invowk flags from command flags
exec invowk cmd 'flags validation' -- --env=staging
stdout '=== Flag Validation Demo ==='
stdout 'regex patterns'
! stderr .

-- invkfile.cue --
cmds: [
	{
		name:        "flags simple"
		description: "Command with simple flags"
		implementations: [{
			script: """
				echo "=== Simple Flags Demo ==="
				echo ""
				echo "Flags passed to this command are available as environment variables:"
				echo "  INVOWK_FLAG_VERBOSE = '${INVOWK_FLAG_VERBOSE}'"
				echo "  INVOWK_FLAG_OUTPUT = '${INVOWK_FLAG_OUTPUT}'"
				echo ""
				if [ -n "$INVOWK_FLAG_VERBOSE" ] && [ "$INVOWK_FLAG_VERBOSE" = "true" ]; then
				    echo "[VERBOSE] Extra verbose information would appear here"
				fi
				if [ -n "$INVOWK_FLAG_OUTPUT" ]; then
				    echo "[OUTPUT] Would write to: $INVOWK_FLAG_OUTPUT"
				fi
				echo ""
				echo "Try: invowk cmd examples flags simple --verbose=true --output=/tmp/out.txt"
				"""
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		flags: [
			{name: "verbose", description: "Enable verbose output"},
			{name: "output", description: "Output file path"},
		]
	},
	{
		name:        "flags defaults"
		description: "Command with flags that have default values"
		implementations: [{
			script: """
				echo "=== Flags with Defaults Demo ==="
				echo ""
				echo "These flags have default values if not specified:"
				echo "  INVOWK_FLAG_ENV = '${INVOWK_FLAG_ENV}' (default: development)"
				echo "  INVOWK_FLAG_RETRY_COUNT = '${INVOWK_FLAG_RETRY_COUNT}' (default: 3)"
				echo "  INVOWK_FLAG_DRY_RUN = '${INVOWK_FLAG_DRY_RUN}' (default: false)"
				echo ""
				if [ "$INVOWK_FLAG_DRY_RUN" = "true" ]; then
				    echo "[DRY-RUN MODE] Would deploy to '$INVOWK_FLAG_ENV' with $INVOWK_FLAG_RETRY_COUNT retries"
				else
				    echo "Deploying to '$INVOWK_FLAG_ENV' with $INVOWK_FLAG_RETRY_COUNT retries..."
				fi
				echo ""
				echo "Try: invowk cmd examples flags defaults --env=production --dry-run=true"
				"""
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		flags: [
			{name: "env", description: "Target environment", default_value: "development"},
			{name: "retry-count", description: "Number of retries", default_value: "3"},
			{name: "dry-run", description: "Perform a dry run without making changes", default_value: "false"},
		]
	},
	{
		name:        "flags typed"
		description: "Command with typed flags (bool, int, float, string)"
		implementations: [{
			script: """
				echo "=== Typed Flags Demo ==="
				echo ""
				echo "These flags have explicit types:"
				echo "  INVOWK_FLAG_VERBOSE (bool) = '$INVOWK_FLAG_VERBOSE'"
				echo "  INVOWK_FLAG_COUNT (int) = '$INVOWK_FLAG_COUNT'"
				echo "  INVOWK_FLAG_THRESHOLD (float) = '$INVOWK_FLAG_THRESHOLD'"
				echo "  INVOWK_FLAG_MESSAGE (string) = '$INVOWK_FLAG_MESSAGE'"
				echo ""
				echo "Typed flags are validated:"
				echo "  - bool: only 'true' or 'false' accepted"
				echo "  - int: only valid integers accepted"
				echo "  - float: only valid floating-point numbers accepted"
				echo "  - string: any value accepted (default)"
				echo ""
				echo "Try: invowk cmd examples flags typed --verbose --count=5 --threshold=0.95 --message='Hello World'"
				"""
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		flags: [
			{name: "verbose", description: "Enable verbose output", type: "bool", default_value: "false"},
			{name: "count", description: "Number of iterations", type: "int", default_value: "1"},
			{name: "threshold", description: "Confidence threshold", type: "float", default_value: "0.75"},
			{name: "message", description: "Message to display", type: "string", default_value: "Hello"},
		]
	},
	{
		name:        "flags short"
		description: "Command with short flag aliases"
		implementations: [{
			script: """
				echo "=== Short Flag Aliases Demo ==="
				echo ""
				echo "These flags have short aliases:"
				echo "  -V / --verbose = '$INVOWK_FLAG_VERBOSE'"
				echo "  -o / --output = '$INVOWK_FLAG_OUTPUT'"
				echo "  -F / --force = '$INVOWK_FLAG_FORCE'"
				echo ""
				echo "Short aliases make command-line usage more convenient."
				echo ""
				echo "Try: invowk cmd examples flags short -V -o=/tmp/out.txt -F"
				"""
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		flags: [
			{name: "verbose", description: "Enable verbose output", type: "bool", short: "V", default_value: "false"},
			{name: "output", description: "Output file path", short: "o"},
			{name: "force", description: "Force overwrite", type: "bool", short: "F", default_value: "false"},
		]
	},
	{
		name:        "flags validation"
		description: "Command with flags validated by regex patterns"
		implementations: [{
			script: """
				echo "=== Flag Validation Demo ==="
				echo ""
				echo "These flags are validated against regex patterns:"
				echo "  --env (dev|staging|prod) = '$INVOWK_FLAG_ENV'"
				echo "  --app-version (semver) = '$INVOWK_FLAG_APP_VERSION'"
				echo ""
				echo "Invalid values will be rejected before the command runs."
				echo ""
				echo "Try: invowk cmd examples flags validation --env=staging --app-version=1.2.3"
				"""
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		flags: [
			{name: "env", description: "Environment (dev, staging, or prod)", validation: "^(dev|staging|prod)$", default_value: "dev"},
			{name: "app-version", description: "Version number (semver format)", validation: #"^[0-9]+\.[0-9]+\.[0-9]+$"#, default_value: "1.0.0"},
		]
	},
]
