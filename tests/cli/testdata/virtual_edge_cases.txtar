# Test: Edge cases for multi-source command discovery
# Tests error handling for edge conditions: reserved module names, source typos

# Change to work directory where the test files will be created
cd $WORK

# =============================================================================
# Test: Reserved module name (invowkfile.invowkmod)
# =============================================================================

# Test 1: Reserved module name 'invowkfile.invowkmod' should be skipped silently
cd $WORK/reserved_name_test
exec invowk cmd
stdout 'From invowkfile:'
stdout 'hello'
# The reserved module should be skipped - its commands shouldn't appear
! stdout 'From invowkfile.invowkmod:'
! stdout 'reserved-cmd'

# =============================================================================
# Test: Typos and invalid source names
# =============================================================================

cd $WORK/typo_test

# Test 2: Typo in @source prefix shows helpful error with suggestions
! exec invowk cmd @fooo deploy
stderr 'not found'
stderr 'Available sources'

# Test 3: Typo in --ivk-from flag shows helpful error
! exec invowk cmd --ivk-from ivkfil deploy
stderr 'not found'
stderr 'Available sources'

# Test 4: Non-existent source with similar name
! exec invowk cmd @ba deploy
stderr 'not found'

# Test 5: Explicit source that doesn't contain the requested command
! exec invowk cmd @foo hello
stderr 'not found in source'

# =============================================================================
# Test files
# =============================================================================

-- reserved_name_test/invowkfile.cue --
cmds: [
	{
		name: "hello"
		description: "Hello from root"
		implementations: [{script: "echo 'Hello!'", runtimes: [{name: "virtual"}], platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]}]
	},
]

-- reserved_name_test/invowkfile.invowkmod/invowkmod.cue --
module: "invowkfile"
version: "1.0.0"
description: "This module uses reserved name"

-- reserved_name_test/invowkfile.invowkmod/invowkfile.cue --
cmds: [
	{
		name: "reserved-cmd"
		description: "Command in reserved module"
		implementations: [{script: "echo 'Reserved!'", runtimes: [{name: "virtual"}], platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]}]
	},
]

-- typo_test/invowkfile.cue --
cmds: [
	{
		name: "deploy"
		description: "Deploy from root"
		implementations: [{script: "echo 'Deploying from invowkfile!'", runtimes: [{name: "virtual"}], platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]}]
	},
	{
		name: "hello"
		description: "Hello from root"
		implementations: [{script: "echo 'Hello!'", runtimes: [{name: "virtual"}], platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]}]
	},
]

-- typo_test/foo.invowkmod/invowkmod.cue --
module: "foo"
version: "1.0.0"
description: "Foo module"

-- typo_test/foo.invowkmod/invowkfile.cue --
cmds: [
	{
		name: "deploy"
		description: "Deploy from foo"
		implementations: [{script: "echo 'Deploying from foo!'", runtimes: [{name: "virtual"}], platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]}]
	},
]
