# Test: Dry-run mode (--ivk-dry-run)
# Verifies that dry-run prints the resolved execution context without executing

cd $WORK

# Test 1: Basic dry-run shows command metadata and script without executing
exec invowk cmd hello --ivk-dry-run
stdout 'Dry Run'
stdout 'Command:.*hello'
stdout 'Source:'
stdout 'Runtime:.*virtual'
stdout 'Platform:'
stdout 'Script:'
stdout 'echo hello world'

# Test 2: Dry-run shows timeout when set
exec invowk cmd slow --ivk-dry-run
stdout 'Timeout:.*30s'
stdout 'Script:'

# Test 3: Dry-run shows execute deps
exec invowk cmd deploy --ivk-dry-run
stdout 'Exec deps:.*build'
stdout 'Script:'
stdout 'echo deploying'

# Test 4: Dry-run shows environment variables
exec invowk cmd hello --ivk-dry-run
stdout 'INVOWK_CMD_NAME=hello'
stdout 'INVOWK_RUNTIME=virtual'

# Test 5: --ivk-watch and --ivk-dry-run are mutually exclusive
! exec invowk cmd hello --ivk-watch --ivk-dry-run
stderr '(?i)--ivk-watch and --ivk-dry-run cannot be used together'

-- invowkfile.cue --
cmds: [
	{
		name:        "hello"
		description: "A simple command"
		implementations: [{
			script:    "echo hello world"
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
	},
	{
		name:        "slow"
		description: "Command with timeout"
		implementations: [{
			script:    "echo slow command"
			timeout:   "30s"
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
	},
	{
		name: "build"
		implementations: [{
			script:    "echo building"
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
	},
	{
		name:        "deploy"
		description: "Command with execute dep"
		implementations: [{
			script:    "echo deploying"
			runtimes:  [{name: "virtual"}]
			platforms: [{name: "linux"}, {name: "macos"}, {name: "windows"}]
		}]
		depends_on: {
			cmds: [
				{alternatives: ["build"], execute: true},
			]
		}
	},
]
