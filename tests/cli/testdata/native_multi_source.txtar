# Test: Multi-source command discovery using native runtime (User Story 1 + User Story 2)
# Mirrors virtual_multi_source.txtar but with platform-split native implementations
# Tests that invowk cmd discovers commands from both invowkfile.cue AND sibling modules
# Tests that unambiguous commands execute with simple names (transparent namespace)

# Change to work directory where the test files will be created
cd $WORK

# Test 1: List commands - should show commands grouped by source
# Commands are displayed with their SimpleName (no module prefix)
exec invowk cmd
stdout 'From invowkfile:'
stdout 'hello'
stdout 'From foo.invowkmod:'
stdout 'build'
stdout 'From bar.invowkmod:'
stdout 'test'
! stderr .

# Test 2: Run unambiguous command from invowkfile using simple name
exec invowk cmd hello
stdout 'Hello from root!'
! stderr .

# Test 3 (US2): Run unambiguous command from module using SIMPLE name (no prefix)
# Transparent namespace: "build" is unique, so it works without "foo" prefix
exec invowk cmd build
stdout 'Building from foo!'
! stderr .

# Test 4 (US2): Run another unambiguous module command using simple name
# Transparent namespace: "test" is unique, so it works without "bar" prefix
exec invowk cmd test
stdout 'Testing from bar!'
! stderr .

-- invowkfile.cue --
cmds: [
	{
		name:        "hello"
		description: "Hello from root invowkfile"
		implementations: [
			{
				script:    "echo 'Hello from root!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Hello from root!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]

-- foo.invowkmod/invowkmod.cue --
module: "foo"
version: "1.0.0"
description: "Foo module"

-- foo.invowkmod/invowkfile.cue --
cmds: [
	{
		name:        "build"
		description: "Build from foo module"
		implementations: [
			{
				script:    "echo 'Building from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Building from foo!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]

-- bar.invowkmod/invowkmod.cue --
module: "bar"
version: "1.0.0"
description: "Bar module"

-- bar.invowkmod/invowkfile.cue --
cmds: [
	{
		name:        "test"
		description: "Test from bar module"
		implementations: [
			{
				script:    "echo 'Testing from bar!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Testing from bar!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]
