# Test: Container environment variable handling
# Tests env vars from invowkfile and CLI override via --ivk-env-var

# Skip if no functional container runtime is available
[!container-available] skip 'no functional container runtime available'
# Skip if running inside Flatpak/Snap sandbox (filesystem permissions may prevent volume mounts)
[in-sandbox] skip 'container tests may require --filesystem permissions in sandbox - run tests on host or grant permissions'

# Change to work directory where local invowkfile.cue is located
cd $WORK

# Test 1: verify env vars from invowkfile are set
exec invowk cmd show-env-demo
stdout '=== Container Environment ==='
stdout 'APP_NAME: demo-app'
stdout 'APP_ENV: development'
stdout 'DEBUG: true'

# Test 2: env-var CLI flag override
exec invowk cmd show-env --ivk-env-var MY_VAR=from-cli
stdout 'MY_VAR: from-cli'

# Test 3: env-var overrides invowkfile env.vars
exec invowk cmd show-env-with-default --ivk-env-var DEFAULT_VAR=overridden
stdout 'DEFAULT_VAR: overridden'

# Test 4: invowkfile env.vars without override
exec invowk cmd show-env-with-default
stdout 'DEFAULT_VAR: from-invowkfile'

-- invowkfile.cue --
cmds: [
	{
		name: "show-env-demo"
		description: "Demonstrate environment variables in container"
		implementations: [
			{
				script: """
					echo "=== Container Environment ==="
					echo "APP_NAME: $APP_NAME"
					echo "APP_ENV: $APP_ENV"
					echo "DEBUG: $DEBUG"
					"""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
		env: {
			vars: {
				APP_NAME: "demo-app"
				APP_ENV:  "development"
				DEBUG:    "true"
			}
		}
	},
	{
		name: "show-env"
		description: "Show environment variable"
		implementations: [
			{
				script: "echo \"MY_VAR: ${MY_VAR:-<not set>}\""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
	},
	{
		name: "show-env-with-default"
		description: "Show environment variable with default from invowkfile"
		implementations: [
			{
				script: "echo \"DEFAULT_VAR: ${DEFAULT_VAR:-<not set>}\""
				runtimes: [{name: "container", image: "debian:stable-slim"}]
				platforms: [{name: "linux"}]
			}
		]
		env: {
			vars: {
				DEFAULT_VAR: "from-invowkfile"
			}
		}
	}
]
