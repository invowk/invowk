# Test: Environment configuration using native runtime
# Mirrors virtual_env.txtar but with platform-split native implementations

cd $WORK

# Test 1: env files basic - load environment from .env file
exec invowk cmd 'env files basic'
stdout 'Basic env\.files Demo'
stdout 'Variables loaded from examples/\.env:'
stdout 'APP_NAME.*invowk-demo'
stdout 'APP_VERSION.*1\.0\.0'
stdout 'APP_ENV.*development'
! stderr .

# Test 2: env vars override - inline vars override file values
exec invowk cmd 'env vars override'
stdout 'env\.files \+ env\.vars Demo'
stdout 'From env\.files'
stdout 'Overridden by env\.vars:'
stdout 'APP_ENV.*production'
stdout 'LOG_LEVEL.*warn'
stdout 'Precedence: env\.files < env\.vars'
! stderr .

-- examples/.env --
# Example .env file for invowk env_files demonstration
# This file is loaded by commands with env_files configuration

# Application settings
APP_NAME=invowk-demo
APP_VERSION=1.0.0
APP_ENV=development

# Feature flags
ENABLE_DEBUG=true
LOG_LEVEL=info

-- invkfile.cue --
cmds: [
	{
		name:        "env files basic"
		description: "Load environment from .env file at command level"
		env: {
			files: ["examples/.env"]
		}
		implementations: [
			{
				script: """
					echo "=========================================="
					echo "  Basic env.files Demo"
					echo "=========================================="
					echo ""
					echo "Variables loaded from examples/.env:"
					echo "  APP_NAME    = '$APP_NAME'"
					echo "  APP_VERSION = '$APP_VERSION'"
					echo "  APP_ENV     = '$APP_ENV'"
					echo "  ENABLE_DEBUG= '$ENABLE_DEBUG'"
					echo "  LOG_LEVEL   = '$LOG_LEVEL'"
					echo ""
					echo "The env.files field loads dotenv files before"
					echo "command execution. Paths are relative to the"
					echo "invkfile location."
					echo "=========================================="
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script: """
					Write-Output "=========================================="
					Write-Output "  Basic env.files Demo"
					Write-Output "=========================================="
					Write-Output ""
					Write-Output "Variables loaded from examples/.env:"
					Write-Output "  APP_NAME    = '$($env:APP_NAME)'"
					Write-Output "  APP_VERSION = '$($env:APP_VERSION)'"
					Write-Output "  APP_ENV     = '$($env:APP_ENV)'"
					Write-Output "  ENABLE_DEBUG= '$($env:ENABLE_DEBUG)'"
					Write-Output "  LOG_LEVEL   = '$($env:LOG_LEVEL)'"
					Write-Output ""
					Write-Output "The env.files field loads dotenv files before"
					Write-Output "command execution. Paths are relative to the"
					Write-Output "invkfile location."
					Write-Output "=========================================="
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
	{
		name:        "env vars override"
		description: "Inline env.vars override env.files values"
		env: {
			files: ["examples/.env"]
			vars: {
				APP_ENV:   "production"
				LOG_LEVEL: "warn"
			}
		}
		implementations: [
			{
				script: """
					echo "=========================================="
					echo "  env.files + env.vars Demo"
					echo "=========================================="
					echo ""
					echo "From env.files (examples/.env):"
					echo "  APP_NAME    = '$APP_NAME' (from file)"
					echo "  APP_VERSION = '$APP_VERSION' (from file)"
					echo ""
					echo "Overridden by env.vars:"
					echo "  APP_ENV   = '$APP_ENV' (vars overrides 'development')"
					echo "  LOG_LEVEL = '$LOG_LEVEL' (vars overrides 'info')"
					echo ""
					echo "Precedence: env.files < env.vars"
					echo "Inline vars always take priority over files."
					echo "=========================================="
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script: """
					Write-Output "=========================================="
					Write-Output "  env.files + env.vars Demo"
					Write-Output "=========================================="
					Write-Output ""
					Write-Output "From env.files (examples/.env):"
					Write-Output "  APP_NAME    = '$($env:APP_NAME)' (from file)"
					Write-Output "  APP_VERSION = '$($env:APP_VERSION)' (from file)"
					Write-Output ""
					Write-Output "Overridden by env.vars:"
					Write-Output "  APP_ENV   = '$($env:APP_ENV) (vars overrides 'development')'"
					Write-Output "  LOG_LEVEL = '$($env:LOG_LEVEL)' (vars overrides 'info')"
					Write-Output ""
					Write-Output "Precedence: env.files < env.vars"
					Write-Output "Inline vars always take priority over files."
					Write-Output "=========================================="
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
	},
]
