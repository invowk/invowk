# Test: Filepath dependency checks using native runtime
# Mirrors virtual_deps_files.txtar but with platform-split native implementations

cd $WORK

# Test 1: deps file single - requires README.md to exist
exec invowk cmd 'deps file single'
stdout 'README\.md exists!'
! stderr .

# Test 2: deps file alternatives - requires any README variant
exec invowk cmd 'deps file alternatives'
stdout 'A README file exists'
! stderr .

# Test 3: deps file permissions - requires specific file permissions
exec invowk cmd 'deps file permissions'
stdout 'Permission checks passed!'
stdout 'Current directory is writable'
stdout 'README\.md is readable'
! stderr .

# Test 4: deps file executable - requires file with execute permission
# On Unix: chmod makes run.sh executable; on Windows: run.bat has executable extension
[!windows] chmod 0755 run.sh
exec invowk cmd 'deps file executable'
stdout 'Executable check passed'
! stderr .

-- invowkfile.cue --
cmds: [
	{
		name:        "deps file single"
		description: "Command requiring a specific file to exist"
		implementations: [
			{
				script:    "echo 'README.md exists!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'README.md exists!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
		depends_on: {
			filepaths: [
				{alternatives: ["README.md"]},
			]
		}
	},
	{
		name:        "deps file alternatives"
		description: "Command requiring any README file"
		implementations: [
			{
				script:    "echo 'A README file exists (one of: README.md, README, readme.md)'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'A README file exists (one of: README.md, README, readme.md)'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
		depends_on: {
			filepaths: [
				{alternatives: ["README.md", "README", "readme.md", "README.txt"]},
			]
		}
	},
	{
		name:        "deps file permissions"
		description: "Command requiring file with specific permissions"
		implementations: [
			{
				script: """
					echo "Permission checks passed!"
					echo "  - Current directory is writable"
					echo "  - README.md is readable"
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script: """
					Write-Output "Permission checks passed!"
					Write-Output "  - Current directory is writable"
					Write-Output "  - README.md is readable"
					"""
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
		depends_on: {
			filepaths: [
				{alternatives: ["."], writable: true},
				{alternatives: ["README.md"], readable: true},
			]
		}
	},
	{
		name:        "deps file executable"
		description: "Command requiring file with execute permission"
		implementations: [
			{
				script:    "echo 'Executable check passed!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "linux"}, {name: "macos"}]
			},
			{
				script:    "Write-Output 'Executable check passed!'"
				runtimes:  [{name: "native"}]
				platforms: [{name: "windows"}]
			},
		]
		depends_on: {
			filepaths: [
				{alternatives: ["run.sh", "run.bat"], executable: true},
			]
		}
	},
]

-- README.md --
# Test README
This file exists so that filepath dependency checks can find it.

-- run.sh --
#!/bin/sh
echo "hello"

-- run.bat --
@echo off
echo hello
