---
sidebar_position: 3
---

import Snippet from '@site/src/components/Snippet';

# Virtual Runtime

The **virtual** runtime uses Invowk™'s built-in POSIX-compatible shell interpreter (powered by [mvdan/sh](https://github.com/mvdan/sh)). It provides consistent shell behavior across all platforms without requiring an external shell.

## How It Works

When you run a command with the virtual runtime, Invowk:

1. Parses the script using the built-in shell parser
2. Executes it in an embedded POSIX-like environment
3. Provides core utilities (echo, test, etc.) built-in

## Basic Usage

<Snippet id="runtime-modes/virtual-basic" />

<Snippet id="runtime-modes/virtual-run" />

## Cross-Platform Consistency

The virtual runtime behaves identically on Linux, macOS, and Windows:

<Snippet id="runtime-modes/virtual-cross-platform" />

No more "works on my machine" for shell scripts!

## Built-in Utilities

The virtual shell includes core POSIX utilities:

| Utility | Description |
|---------|-------------|
| `echo` | Print text |
| `printf` | Formatted output |
| `test` / `[` | Conditionals |
| `true` / `false` | Exit with 0/1 |
| `pwd` | Print working directory |
| `cd` | Change directory |
| `read` | Read input |
| `export` | Set environment variables |

### Extended Utilities (u-root)

When enabled in config (default: `true`), 28 additional POSIX-compliant utilities from the [u-root](https://github.com/u-root/u-root) library are available. These include 12 upstream u-root wrappers and 16 custom implementations.

<Snippet id="runtime-modes/virtual-uroot-config" />

#### File Operations (13 utilities)

| Utility | Description | Common Flags |
|---------|-------------|--------------|
| `base64` | Encode/decode base64 | `-d` (decode) |
| `cat` | Concatenate and display files | `-u` (ignored, compatibility) |
| `cp` | Copy files and directories | `-r` (recursive), `-f` (force) |
| `find` | Search for files in a directory hierarchy | `-name` (pattern), `-type` (f, d, l) |
| `gzip` | Compress or expand files | `-d` (decompress), `-c` (stdout), `-f` (force) |
| `ln` | Create hard or symbolic links | `-s` (symbolic), `-f` (force) |
| `ls` | List directory contents | `-l` (long), `-a` (all), `-R` (recursive) |
| `mkdir` | Create directories | `-p` (create parents) |
| `mktemp` | Create temporary files or directories | `-d` (directory), `-p` (prefix dir) |
| `mv` | Move or rename files | `-f` (force), `-n` (no clobber) |
| `rm` | Remove files and directories | `-r` (recursive), `-f` (force) |
| `tar` | Archive files | `-c` (create), `-x` (extract), `-f` (file) |
| `touch` | Create or update file timestamps | `-c` (no create) |

#### Text Processing (11 utilities)

| Utility | Description | Common Flags |
|---------|-------------|--------------|
| `basename` | Strip directory and suffix from filenames | *(none)* |
| `cut` | Select portions of lines | `-d` (delimiter), `-f` (fields) |
| `dirname` | Strip last component from filenames | *(none)* |
| `grep` | Search for patterns | `-i` (ignore case), `-v` (invert), `-n` (line numbers) |
| `head` | Output first N lines | `-n <num>` (default 10) |
| `realpath` | Resolve absolute path names | *(none)* |
| `sort` | Sort lines | `-r` (reverse), `-n` (numeric), `-u` (unique) |
| `tail` | Output last N lines | `-n <num>` (default 10) |
| `tr` | Translate characters | `SET1 SET2` (character mapping) |
| `uniq` | Filter adjacent duplicate lines | `-c` (count), `-d` (duplicates only) |
| `wc` | Count lines, words, bytes | `-l` (lines), `-w` (words), `-c` (bytes) |

#### Other Utilities (4 utilities)

| Utility | Description | Common Flags |
|---------|-------------|--------------|
| `seq` | Generate number sequences | `-s` (separator), `-w` (equal width) |
| `shasum` | Compute SHA message digests | `-a` (algorithm: 1, 256, 512) |
| `sleep` | Delay for a specified time | *(none — takes duration argument)* |
| `tee` | Duplicate standard input to files | `-a` (append) |

:::note
These utilities implement POSIX behavior. GNU-specific flags (like `--color`, `--time-style`) are silently ignored for compatibility.
:::

#### Error Identification

Errors from u-root utilities are prefixed with `[uroot]` for easy identification:

```
[uroot] cp: /source/file: no such file or directory
[uroot] rm: /protected: permission denied
```

#### No Silent Fallback

If a u-root command fails, it returns an error immediately. The system does **not** fall back to host binaries, ensuring bugs are caught rather than masked

## POSIX Shell Features

The virtual shell supports standard POSIX constructs:

### Variables

<Snippet id="runtime-modes/virtual-variables" />

### Conditionals

<Snippet id="runtime-modes/virtual-conditionals" />

### Loops

<Snippet id="runtime-modes/virtual-loops" />

### Functions

<Snippet id="runtime-modes/virtual-functions" />

### Subshells and Command Substitution

<Snippet id="runtime-modes/virtual-subshells" />

## Calling External Commands

The virtual shell can call external commands installed on your system:

<Snippet id="runtime-modes/virtual-external-commands" />

External commands are found using the system's PATH.

## Environment Variables

Environment variables work the same as in native:

<Snippet id="runtime-modes/virtual-env-vars" />

## Flags and Arguments

Access flags and arguments the same way:

<Snippet id="runtime-modes/virtual-args" />

## Limitations

### No Interpreter Support

The virtual runtime **cannot** use non-shell interpreters:

<Snippet id="runtime-modes/virtual-no-interpreter" />

For Python, Ruby, or other interpreters, use the native or container runtime.

### Bash-Specific Features

Some bash-specific features are not available:

<Snippet id="runtime-modes/virtual-bash-limitations" />

Stick to POSIX-compatible constructs for virtual runtime.

## Dependency Validation

Dependencies are validated against the virtual shell's capabilities:

<Snippet id="runtime-modes/virtual-deps" />

## Advantages

- **Consistency**: Same behavior on Linux, macOS, and Windows
- **No shell dependency**: Works even if system shell is unavailable
- **Portability**: Scripts work across all platforms
- **Built-in utilities**: Core utilities always available
- **Faster startup**: No shell process to spawn

## When to Use Virtual

- **Cross-platform scripts**: When the same script must work everywhere
- **CI/CD pipelines**: Consistent behavior across build agents
- **Simple shell scripts**: When you don't need bash-specific features
- **Embedded environments**: When external shells aren't available

## Configuration

Configure the virtual shell in your Invowk config file:

<Snippet id="runtime-modes/virtual-config" />

## Next Steps

- [Native Runtime](./native) - For full shell access
- [Container Runtime](./container) - For isolated execution
