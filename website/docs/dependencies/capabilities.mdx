---
sidebar_position: 5
---

import Snippet from '@site/src/components/Snippet';

# Capability Dependencies

Capability dependencies verify that required system capabilities are available before your command runs. Currently, Invowk™ supports network connectivity checks.

## Available Capabilities

| Capability | Description |
|------------|-------------|
| `local-area-network` | Checks for LAN connectivity |
| `internet` | Checks for internet connectivity |

## Basic Usage

<Snippet id="dependencies/capabilities-basic" />

If internet connectivity isn't available:

```
✗ Dependencies not satisfied

Command 'deploy' has unmet dependencies:

Missing Capabilities:
  • internet - no internet connectivity

Ensure the required capabilities are available and try again.
```

## Internet Connectivity

Check for working internet access:

```cue
depends_on: {
    capabilities: [
        {alternatives: ["internet"]}
    ]
}
```

This checks:
- DNS resolution is working
- Can reach external hosts
- Network is not blocked

### Use Cases

```cue
// Download dependencies
{
    name: "deps"
    depends_on: {
        capabilities: [{alternatives: ["internet"]}]
    }
    implementations: [{
        script: "go mod download"
        target: {runtimes: [{name: "native"}]}
    }]
}

// Deploy to cloud
{
    name: "deploy"
    depends_on: {
        capabilities: [{alternatives: ["internet"]}]
    }
    implementations: [{
        script: "kubectl apply -f k8s/"
        target: {runtimes: [{name: "native"}]}
    }]
}

// Fetch remote data
{
    name: "sync"
    depends_on: {
        capabilities: [{alternatives: ["internet"]}]
    }
    implementations: [{
        script: "curl -o data.json https://api.example.com/data"
        target: {runtimes: [{name: "native"}]}
    }]
}
```

## Local Area Network

Check for LAN connectivity:

```cue
depends_on: {
    capabilities: [
        {alternatives: ["local-area-network"]}
    ]
}
```

This checks:
- Network interface is up
- Can communicate on local network
- Useful for on-premise services

### Use Cases

```cue
// Connect to local database
{
    name: "db connect"
    depends_on: {
        capabilities: [{alternatives: ["local-area-network"]}]
    }
    implementations: [{
        script: "psql -h db.local -U admin"
        target: {runtimes: [{name: "native"}]}
    }]
}

// Access local services
{
    name: "check services"
    depends_on: {
        capabilities: [{alternatives: ["local-area-network"]}]
    }
    implementations: [{
        script: "curl http://service.local:8080/health"
        target: {runtimes: [{name: "native"}]}
    }]
}
```

## Alternatives (OR Semantics)

Require either capability:

```cue
depends_on: {
    capabilities: [
        // Either internet OR LAN is fine
        {alternatives: ["internet", "local-area-network"]}
    ]
}
```

This is useful when a command can work with either:
- Remote cloud services (internet)
- Local on-premise services (LAN)

## Real-World Examples

### Package Installation

```cue
{
    name: "install"
    description: "Install project dependencies"
    depends_on: {
        capabilities: [{alternatives: ["internet"]}]
        tools: [{alternatives: ["npm", "pnpm", "yarn"]}]
    }
    implementations: [{
        script: "npm install"
        target: {runtimes: [{name: "native"}]}
    }]
}
```

### CI Pipeline

```cue
{
    name: "ci"
    description: "Run CI pipeline with remote checks"
    depends_on: {
        capabilities: [
            {alternatives: ["internet"]}  // For dependency download
        ]
        tools: [
            {alternatives: ["go"]},
            {alternatives: ["git"]},
        ]
    }
    implementations: [{
        script: """
            go mod download
            go build ./...
            go test ./...
            """
        target: {runtimes: [{name: "native"}]}
    }]
}
```

### Hybrid Environment

```cue
{
    name: "backup"
    description: "Backup to available storage"
    depends_on: {
        // Can backup to cloud (internet) or NAS (LAN)
        capabilities: [{alternatives: ["internet", "local-area-network"]}]
    }
    implementations: [{
        script: """
            if ping -c 1 nas.local > /dev/null 2>&1; then
                rsync -av ./data nas.local:/backup/
            else
                aws s3 sync ./data s3://my-backup-bucket/
            fi
            """
        target: {runtimes: [{name: "native"}]}
    }]
}
```

## Offline-First Pattern

Design commands that work offline when possible:

```cue
commands: [
    // Online version - downloads latest
    {
        name: "update deps"
        depends_on: {
            capabilities: [{alternatives: ["internet"]}]
        }
        implementations: [{
            script: "go mod download"
            target: {runtimes: [{name: "native"}]}
        }]
    },
    
    // Offline version - uses cache
    {
        name: "build"
        // No internet requirement - uses cached modules
        depends_on: {
            filepaths: [{alternatives: ["go.mod"]}]
        }
        implementations: [{
            script: "go build -mod=readonly ./..."
            target: {runtimes: [{name: "native"}]}
        }]
    }
]
```

## Container Context

For container runtime, capability checks are performed on the **host**, not inside the container:

```cue
{
    name: "deploy"
    depends_on: {
        // Internet check happens on HOST
        capabilities: [{alternatives: ["internet"]}]
    }
    implementations: [{
        script: "kubectl apply -f k8s/"
        target: {runtimes: [{name: "container", image: "bitnami/kubectl"}]}
    }]
}
```

This makes sense because:
- Container networking inherits from host
- You're checking if the deployment can reach external services
- Container network is ephemeral

## Best Practices

1. **Only check when necessary**: Don't require internet for offline-capable tasks
2. **Use alternatives**: When local or cloud services are interchangeable
3. **Fail fast**: Check connectivity before starting long operations
4. **Provide fallbacks**: Offer offline alternatives when possible

## Next Steps

- [Environment Variables](./env-vars) - Check for required env vars
- [Custom Checks](./custom-checks) - Write custom validation scripts
