---
sidebar_position: 4
---

# Lock File

The lock file (`invowk.lock.cue`) records the exact versions of all resolved modules, ensuring reproducible builds across different machines and over time.

## Purpose

The lock file serves several important purposes:

1. **Reproducibility**: Same versions are used everywhere
2. **Speed**: Skips resolution when versions are already locked
3. **Auditability**: See exactly what versions are in use
4. **Collaboration**: Team members get identical dependencies

## File Format

The lock file uses CUE format for consistency with invkfiles:

```cue
// invowk.lock.cue - Auto-generated lock file for module dependencies
// DO NOT EDIT MANUALLY

version: "1.0"
generated: "2025-01-12T10:30:00Z"

modules: {
	"https://github.com/company/build-tools.git": {
		git_url:          "https://github.com/company/build-tools.git"
		version:          "^2.0.0"
		resolved_version: "2.3.1"
		git_commit:       "abc123def456789012345678901234567890abcd"
		namespace:        "build-tools@2.3.1"
	}
	"https://github.com/company/deploy-utils.git": {
		git_url:          "https://github.com/company/deploy-utils.git"
		version:          "~1.5.0"
		resolved_version: "1.5.2"
		git_commit:       "def456789012345678901234567890abcdef12"
		alias:            "deploy"
		namespace:        "deploy"
	}
	"https://github.com/user/monorepo.git#packages/cli": {
		git_url:          "https://github.com/user/monorepo.git"
		version:          "^1.0.0"
		resolved_version: "1.2.0"
		git_commit:       "789012345678901234567890abcdef1234567890"
		path:             "packages/cli"
		namespace:        "cli@1.2.0"
	}
}
```

## Fields

### Top-Level Fields

| Field | Description |
|-------|-------------|
| `version` | Lock file format version |
| `generated` | Timestamp when the lock file was generated |
| `modules` | Map of module keys to locked module entries |

### Module Entry Fields

| Field | Description |
|-------|-------------|
| `git_url` | Original Git repository URL |
| `version` | Original version constraint from invkfile |
| `resolved_version` | Exact version that was resolved |
| `git_commit` | Full Git commit SHA for the version |
| `alias` | Custom namespace alias (if specified) |
| `path` | Subdirectory path (if specified) |
| `namespace` | Computed namespace for commands |

## Module Keys

The module key in the `modules` map is derived from the Git URL and optional path:

```cue
modules: {
	// Simple URL
	"https://github.com/user/pack.git": { ... }

	// URL with path (for monorepos)
	"https://github.com/user/monorepo.git#packages/cli": { ... }
}
```

## Version Control

### Should I Commit the Lock File?

**Yes!** The lock file should be committed to version control.

**Benefits:**
- Team members get identical module versions
- CI/CD uses the same versions as development
- Rollbacks restore exact dependency state
- Auditing and security reviews are easier

### .gitignore

Do NOT add `invowk.lock.cue` to `.gitignore`.

## Workflows

### Fresh Installation

When cloning a project with a lock file:

```bash
git clone https://github.com/yourorg/project.git
cd project
invowk module sync
```

The sync command uses the lock file to download exact versions without re-resolving.

### Updating Dependencies

To update to newer versions:

```bash
# Update all modules
invowk module update

# Review changes
git diff invowk.lock.cue

# Test your project

# Commit if everything works
git add invowk.lock.cue
git commit -m "Update module dependencies"
```

### Resolving Conflicts

If the lock file has merge conflicts:

```bash
# Option 1: Re-sync (may change versions)
git checkout --theirs invowk.lock.cue  # or --ours
invowk module sync

# Option 2: Manual resolution
# Edit the file to resolve conflicts
# Then sync to validate
invowk module sync
```

## Lock File vs Invkfile

| Aspect | `invkfile.cue` | `invowk.lock.cue` |
|--------|----------------|-------------------|
| Purpose | Declare dependencies | Record resolved versions |
| Edited by | Human | Generated by invowk |
| Contains | Version constraints | Exact versions |
| Changes | When requirements change | When syncing/updating |

### Example Relationship

**invkfile.cue** (what you write):
```cue
requires: [
	{
		git_url: "https://github.com/user/pack.git"
		version: "^1.0.0"  // Accept any 1.x.x
	},
]
```

**invowk.lock.cue** (what invowk generates):
```cue
modules: {
	"https://github.com/user/pack.git": {
		version:          "^1.0.0"
		resolved_version: "1.2.3"  // Specific version
		git_commit:       "abc123..."
	}
}
```

## Troubleshooting

### Lock File Out of Sync

If the lock file doesn't match your invkfile:

```bash
# Re-sync from invkfile
invowk module sync
```

### Missing Lock File

If the lock file is missing but invkfile has requirements:

```bash
# Generate a new lock file
invowk module sync
```

### Corrupted Lock File

If the lock file is corrupted or invalid:

```bash
# Delete and regenerate
rm invowk.lock.cue
invowk module sync
```

### Version Mismatch

If you need a different version than what's locked:

1. Update the constraint in `invkfile.cue`
2. Run `invowk module update` or `invowk module sync`

## Best Practices

### 1. Always Commit Lock Files

```bash
git add invowk.lock.cue
git commit -m "Lock module dependencies"
```

### 2. Update Intentionally

Don't update dependencies accidentally. Update explicitly and test:

```bash
invowk module update
# Run tests
git add invowk.lock.cue
git commit -m "Update dependencies"
```

### 3. Review Lock File Changes

When the lock file changes in a PR, review what versions changed:

```bash
git diff main..feature-branch -- invowk.lock.cue
```

### 4. Pin Critical Dependencies

For production systems, consider using exact versions:

```cue
requires: [
	{
		git_url: "https://github.com/user/critical-tool.git"
		version: "1.2.3"  // Exact version, no ^
	},
]
```

## Security Considerations

### Commit Hash Verification

The lock file records Git commit SHAs. This provides:

- **Integrity**: Ensures you get the exact code
- **Immutability**: Tags can be moved, commits cannot
- **Auditability**: Know exactly what code is running

### Dependency Review

Periodically review your dependencies:

```bash
# List all modules with their sources
invowk module list
```

### Private Repositories

Ensure authentication is properly configured for private repos:

```bash
# SSH (recommended for private repos)
export SSH_AUTH_SOCK=...

# Or HTTPS with token
export GITHUB_TOKEN=ghp_xxxx
```
