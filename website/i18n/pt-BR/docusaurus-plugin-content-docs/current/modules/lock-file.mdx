---
sidebar_position: 4
---

# Arquivo de Lock

O arquivo de lock (`invowk.lock.cue`) registra as versões exatas de todos os módulos resolvidos, garantindo builds reprodutíveis em diferentes máquinas e ao longo do tempo.

## Propósito

O arquivo de lock serve a vários propósitos importantes:

1. **Reprodutibilidade**: As mesmas versões são usadas em todos os lugares
2. **Velocidade**: Pula a resolução quando as versões já estão travadas
3. **Auditabilidade**: Veja exatamente quais versões estão em uso
4. **Colaboração**: Membros da equipe obtêm dependências idênticas

## Formato do Arquivo

O arquivo de lock usa formato CUE para consistência com invkfiles:

```cue
// invowk.lock.cue - Arquivo de lock auto-gerado para dependências de módulos
// NÃO EDITE MANUALMENTE

version: "1.0"
generated: "2025-01-12T10:30:00Z"

modules: {
	"https://github.com/company/build-tools.git": {
		git_url:          "https://github.com/company/build-tools.git"
		version:          "^2.0.0"
		resolved_version: "2.3.1"
		git_commit:       "abc123def456789012345678901234567890abcd"
		namespace:        "build-tools@2.3.1"
	}
	"https://github.com/company/deploy-utils.git": {
		git_url:          "https://github.com/company/deploy-utils.git"
		version:          "~1.5.0"
		resolved_version: "1.5.2"
		git_commit:       "def456789012345678901234567890abcdef12"
		alias:            "deploy"
		namespace:        "deploy"
	}
	"https://github.com/user/monorepo.git#packages/cli": {
		git_url:          "https://github.com/user/monorepo.git"
		version:          "^1.0.0"
		resolved_version: "1.2.0"
		git_commit:       "789012345678901234567890abcdef1234567890"
		path:             "packages/cli"
		namespace:        "cli@1.2.0"
	}
}
```

## Campos

### Campos de Nível Superior

| Campo | Descrição |
|-------|-----------|
| `version` | Versão do formato do arquivo de lock |
| `generated` | Timestamp de quando o arquivo de lock foi gerado |
| `modules` | Mapa de chaves de módulo para entradas de módulo travado |

### Campos de Entrada de Módulo

| Campo | Descrição |
|-------|-----------|
| `git_url` | URL original do repositório Git |
| `version` | Restrição de versão original do invkfile |
| `resolved_version` | Versão exata que foi resolvida |
| `git_commit` | SHA completo do commit Git para a versão |
| `alias` | Alias de namespace personalizado (se especificado) |
| `path` | Caminho do subdiretório (se especificado) |
| `namespace` | Namespace computado para comandos |

## Chaves de Módulo

A chave do módulo no mapa `modules` é derivada da URL Git e caminho opcional:

```cue
modules: {
	// URL simples
	"https://github.com/user/pack.git": { ... }

	// URL com caminho (para monorepos)
	"https://github.com/user/monorepo.git#packages/cli": { ... }
}
```

## Controle de Versão

### Devo Fazer Commit do Arquivo de Lock?

**Sim!** O arquivo de lock deve ser commitado no controle de versão.

**Benefícios:**
- Membros da equipe obtêm versões de módulos idênticas
- CI/CD usa as mesmas versões do desenvolvimento
- Rollbacks restauram estado exato de dependências
- Auditorias e revisões de segurança são mais fáceis

### .gitignore

NÃO adicione `invowk.lock.cue` ao `.gitignore`.

## Fluxos de Trabalho

### Instalação Nova

Ao clonar um projeto com arquivo de lock:

```bash
git clone https://github.com/suaorg/projeto.git
cd projeto
invowk module sync
```

O comando sync usa o arquivo de lock para baixar versões exatas sem re-resolver.

### Atualizando Dependências

Para atualizar para versões mais novas:

```bash
# Atualizar todos os módulos
invowk module update

# Revisar mudanças
git diff invowk.lock.cue

# Testar seu projeto

# Fazer commit se tudo funcionar
git add invowk.lock.cue
git commit -m "Atualizar dependências de módulos"
```

### Resolvendo Conflitos

Se o arquivo de lock tiver conflitos de merge:

```bash
# Opção 1: Re-sincronizar (pode mudar versões)
git checkout --theirs invowk.lock.cue  # ou --ours
invowk module sync

# Opção 2: Resolução manual
# Edite o arquivo para resolver conflitos
# Depois sincronize para validar
invowk module sync
```

## Arquivo de Lock vs Invkfile

| Aspecto | `invkfile.cue` | `invowk.lock.cue` |
|---------|----------------|-------------------|
| Propósito | Declarar dependências | Registrar versões resolvidas |
| Editado por | Humano | Gerado pelo invowk |
| Contém | Restrições de versão | Versões exatas |
| Muda | Quando requisitos mudam | Ao sincronizar/atualizar |

### Exemplo de Relacionamento

**invkfile.cue** (o que você escreve):
```cue
requires: [
	{
		git_url: "https://github.com/user/pack.git"
		version: "^1.0.0"  // Aceita qualquer 1.x.x
	},
]
```

**invowk.lock.cue** (o que invowk gera):
```cue
modules: {
	"https://github.com/user/pack.git": {
		version:          "^1.0.0"
		resolved_version: "1.2.3"  // Versão específica
		git_commit:       "abc123..."
	}
}
```

## Solução de Problemas

### Arquivo de Lock Dessincronizado

Se o arquivo de lock não corresponde ao seu invkfile:

```bash
# Re-sincronize do invkfile
invowk module sync
```

### Arquivo de Lock Ausente

Se o arquivo de lock está ausente mas invkfile tem requisitos:

```bash
# Gere um novo arquivo de lock
invowk module sync
```

### Arquivo de Lock Corrompido

Se o arquivo de lock está corrompido ou inválido:

```bash
# Delete e regenere
rm invowk.lock.cue
invowk module sync
```

### Incompatibilidade de Versão

Se você precisa de uma versão diferente da travada:

1. Atualize a restrição em `invkfile.cue`
2. Execute `invowk module update` ou `invowk module sync`

## Boas Práticas

### 1. Sempre Faça Commit de Arquivos de Lock

```bash
git add invowk.lock.cue
git commit -m "Travar dependências de módulos"
```

### 2. Atualize Intencionalmente

Não atualize dependências acidentalmente. Atualize explicitamente e teste:

```bash
invowk module update
# Execute testes
git add invowk.lock.cue
git commit -m "Atualizar dependências"
```

### 3. Revise Mudanças no Arquivo de Lock

Quando o arquivo de lock muda em um PR, revise quais versões mudaram:

```bash
git diff main..feature-branch -- invowk.lock.cue
```

### 4. Fixe Dependências Críticas

Para sistemas de produção, considere usar versões exatas:

```cue
requires: [
	{
		git_url: "https://github.com/user/ferramenta-critica.git"
		version: "1.2.3"  // Versão exata, sem ^
	},
]
```

## Considerações de Segurança

### Verificação de Hash de Commit

O arquivo de lock registra SHAs de commits Git. Isso fornece:

- **Integridade**: Garante que você obtém o código exato
- **Imutabilidade**: Tags podem ser movidas, commits não
- **Auditabilidade**: Saber exatamente qual código está executando

### Revisão de Dependências

Revise periodicamente suas dependências:

```bash
# Liste todos os módulos com suas origens
invowk module list
```

### Repositórios Privados

Garanta que a autenticação está configurada corretamente para repos privados:

```bash
# SSH (recomendado para repos privados)
export SSH_AUTH_SOCK=...

# Ou HTTPS com token
export GITHUB_TOKEN=ghp_xxxx
```
