---
sidebar_position: 4
---

import Snippet from '@site/src/components/Snippet';

# Dependências de Comandos

Dependências de comandos garantem que outros comandos Invowk™ sejam executados com sucesso antes que seu comando execute.

## Uso Básico

<Snippet id="dependencies/commands-basic" />

Quando você executa `deploy`, o Invowk primeiro executa `build`. Se `build` falhar, `deploy` não será executado.

## Nomes Completos de Comando

Sempre use o **nome completo prefixado com o grupo**:

```cue
group: "myproject"

cmds: [
    {
        name: "build"
        implementations: [...]
    },
    {
        name: "test"
        depends_on: {
            cmds: [
                // Deve incluir o prefixo do grupo "myproject"
                {alternatives: ["myproject build"]}
            ]
        }
        implementations: [...]
    }
]
```

## Alternativas (Semântica OU)

Especifique alternativas quando qualquer comando funcionar:

```cue
depends_on: {
    cmds: [
        // Build debug OU release
        {alternatives: ["myproject build debug", "myproject build release"]},
        
        // Testes unitários OU de integração
        {alternatives: ["myproject test unit", "myproject test integration"]},
    ]
}
```

A dependência é satisfeita se **qualquer** alternativa tiver sido executada com sucesso.

## Múltiplos Requisitos de Comando

Cada entrada é um requisito E:

```cue
depends_on: {
    cmds: [
        // Precisa de build E test E lint
        {alternatives: ["myproject build"]},
        {alternatives: ["myproject test"]},
        {alternatives: ["myproject lint"]},
    ]
}
```

Todos os três comandos devem ter sucesso (embora alternativas dentro de cada um sejam OU).

## Cadeias de Comandos

Construa workflows complexos com cadeias de comandos:

```cue
group: "myproject"

cmds: [
    // Comando base
    {
        name: "clean"
        implementations: [{
            script: "rm -rf build/"
            target: {runtimes: [{name: "native"}]}
        }]
    },
    
    // Depende de clean
    {
        name: "build"
        depends_on: {
            cmds: [{alternatives: ["myproject clean"]}]
        }
        implementations: [{
            script: "go build -o build/app ./..."
            target: {runtimes: [{name: "native"}]}
        }]
    },
    
    // Depende de build
    {
        name: "test"
        depends_on: {
            cmds: [{alternatives: ["myproject build"]}]
        }
        implementations: [{
            script: "go test ./..."
            target: {runtimes: [{name: "native"}]}
        }]
    },
    
    // Depende de test (que depende de build, que depende de clean)
    {
        name: "release"
        depends_on: {
            cmds: [{alternatives: ["myproject test"]}]
        }
        implementations: [{
            script: "./scripts/release.sh"
            target: {runtimes: [{name: "native"}]}
        }]
    }
]
```

Executar `release` executa: `clean` → `build` → `test` → `release`

## Dependências Entre Invkfiles

Comandos podem depender de comandos de outros invkfiles:

```cue
// Em frontend/invkfile.cue
group: "frontend"

cmds: [
    {
        name: "build"
        depends_on: {
            cmds: [
                // Depende de um comando do invkfile shared
                {alternatives: ["shared generate-types"]}
            ]
        }
        implementations: [...]
    }
]
```

```cue
// Em shared/invkfile.cue
group: "shared"

cmds: [
    {
        name: "generate-types"
        implementations: [...]
    }
]
```

## Exemplos do Mundo Real

### Pipeline de CI/CD

```cue
group: "myapp"

cmds: [
    {name: "lint", implementations: [...]},
    {name: "test unit", implementations: [...]},
    {name: "test integration", implementations: [...]},
    {name: "build", implementations: [...]},
    
    {
        name: "ci"
        description: "Executar pipeline completo de CI"
        depends_on: {
            cmds: [
                {alternatives: ["myapp lint"]},
                {alternatives: ["myapp test unit"]},
                {alternatives: ["myapp test integration"]},
                {alternatives: ["myapp build"]},
            ]
        }
        implementations: [{
            script: "echo 'CI passou!'"
            target: {runtimes: [{name: "native"}]}
        }]
    }
]
```

### Variantes de Build

```cue
group: "myapp"

cmds: [
    {
        name: "build debug"
        implementations: [{
            script: "go build -gcflags='all=-N -l' -o build/app-debug ./..."
            target: {runtimes: [{name: "native"}]}
        }]
    },
    {
        name: "build release"
        implementations: [{
            script: "go build -ldflags='-s -w' -o build/app ./..."
            target: {runtimes: [{name: "native"}]}
        }]
    },
    
    {
        name: "deploy"
        depends_on: {
            cmds: [
                // Deve ter executado build debug ou release
                {alternatives: ["myapp build debug", "myapp build release"]}
            ]
        }
        implementations: [{
            script: "./scripts/deploy.sh"
            target: {runtimes: [{name: "native"}]}
        }]
    }
]
```

### Microserviços

```cue
group: "monorepo"

cmds: [
    {
        name: "api build"
        implementations: [...]
    },
    {
        name: "web build"
        implementations: [...]
    },
    {
        name: "deploy all"
        depends_on: {
            cmds: [
                {alternatives: ["monorepo api build"]},
                {alternatives: ["monorepo web build"]},
            ]
        }
        implementations: [{
            script: "./scripts/deploy-all.sh"
            target: {runtimes: [{name: "native"}]}
        }]
    }
]
```

## Fluxo de Execução

Quando um comando com dependências é executado:

```
invowk cmd myproject deploy
       │
       ▼
┌──────────────────┐
│ Verificar deps   │
│ (lista commands) │
└────────┬─────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────┐
│ build │ │ test  │
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │ deploy  │
    └─────────┘
```

Dependências são executadas na ordem especificada. Se alguma falhar, a execução para.

## Herança de Runtime

Comandos dependentes usam suas próprias configurações de runtime:

```cue
{
    name: "build"
    implementations: [{
        script: "go build ./..."
        target: {runtimes: [{name: "container", image: "golang:1.21"}]}
    }]
}

{
    name: "deploy"
    depends_on: {
        cmds: [{alternatives: ["myproject build"]}]
    }
    implementations: [{
        script: "./scripts/deploy.sh"
        target: {runtimes: [{name: "native"}]}
    }]
}
```

Quando você executa `deploy`:
1. `build` roda em um container
2. `deploy` roda nativamente

Cada comando usa sua própria configuração.

## Melhores Práticas

1. **Use nomes completos**: Sempre inclua o prefixo do grupo
2. **Mantenha cadeias rasas**: Cadeias profundas podem ser difíceis de debugar
3. **Use alternativas sabiamente**: Para comandos verdadeiramente intercambiáveis
4. **Considere paralelismo**: Comandos independentes podem rodar em paralelo (feature futura)

## Próximos Passos

- [Capabilities](./capabilities) - Verificar capacidades do sistema
- [Environment Variables](./env-vars) - Verificar variáveis de ambiente requeridas
